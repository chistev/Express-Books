<%- include('layout') %>

<title><%= title %></title>
<%- include('navbar') %>

<div class="container">
    <div class="row">
        <div class="col-md-3 col-10 mt-2 d-flex flex-column ">
            <div class="ms-3">
                <img src="<%= book.image %>" alt="<%= book.title %>" class="image" style="width: 65%;">
            </div>
        </div>

        <div class="col-md-7">
            <div class="mb-1" style="font-family: Georgia, serif; font-weight: 600; font-size: 36px; line-height: 46px; color: #1e1915;">
                    <%= book.title %>
            </div>
            <div class="mb-1">
                <a class="text-decoration-none" href="" style="font-family: Georgia, serif; font-weight: 400; font-size: 20px; line-height: 28px; color: #1e1915;">
                    <%= book.author %>
                </a>
            </div>
            <div class="d-flex align-items-center ">
                
                
                
                <div class="d-flex align-items-center justify-content-center">
                    
                    <div class="ms-2" style="font-family: Arial, sans-serif; font-weight: 400; font-size: 14px; line-height: 19px; color: #707070;">
                        2,685 reviews
                    </div>
                </div>  
            </div>
            <div class="description-container" id="description-container-<%= book._id %>" style="font-family: Arial, sans-serif; font-weight: 400; font-size: 16px; line-height: 22px; color: #1e1915;">
                <p class="mb-2 short-description">
                    <%- book.description %>
                </p>
                <div class="show-more-button">
                    <a style="font-weight: 600; font-size: 14px; line-height: 20px; color: #1e1915;" class="text-decoration-none show-more-link" data-book-id="<%= book._id %>" href="#">
                        Show more &#9662;
                    </a>
                </div>
            </div>
            <div class="d-flex align-items-center mt-3">
                <div style="font-family: Arial, sans-serif; font-weight: 400; font-size: 14px; line-height: 18px; color: #707070;">Genres:</div>
                <% book.genre.forEach(function(genre) { %>
                    <div class="ms-2" style="font-family: Arial, sans-serif; font-weight: 600; font-size: 14px; line-height: 20px;">
                        <a class="genre-link" href="/genre/<%= genre %>" style="color: #1e1915; text-decoration: underline; text-decoration-color: #409970; text-decoration-thickness: 2px;">
                            <%= genre %>
                        </a>
                    </div>
                <% }); %>
            </div>
            <div class="mt-2" style="font-family: Arial, sans-serif; font-weight: 400; font-size: 14px; line-height: 18px; color: #707070;"><%= book.pages %> pages, <%= book.mediaType %></div>
            <div class="mt-2" style="font-family: Arial, sans-serif; font-weight: 400; font-size: 14px; line-height: 18px; color: #707070;">
                First published <%= new Date(book.publishedDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
            </div>
            <hr>
            
            <div style="font-family: Georgia, serif; font-style: italic; font-weight: 600; font-size: 28px; line-height: 38px; color: #1e1915;">Reviews</div>
            <div class="d-flex align-items-center justify-content-center">
                <div class="mt-5" style="font-family: Georgia, serif; font-style: italic; font-weight: 600; font-size: 32px; line-height: 46px; color: #1e1915;">
                    What do you think?
                </div>
                
            </div>
            <div class="d-flex row align-items-center justify-content-center">
                    <a href="<%= loggedIn ? `/write_review/${book._id}` : '/signup' %>"  class="btn mb-2" style="background-color: #1e1915; color: #ffffff; border-radius: 20%; width: 50%;">
                    Write a Review
                </a>
                <hr>
            </div>
            <div style="font-family: Georgia, serif; font-weight: 600; font-size: 20px; line-height: 28px; color: #1e1915;">
                Community Reviews
            </div>
            
                        
            <div class="search-filter-container mt-2">
                <div class="search-input">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Search review text">
                </div>
                <button class="filter-button">
                    <i class="bi bi-funnel"></i> Filters
                </button>
            </div>
            <div class="ms-3" style="font-family: Arial, sans-serif; font-weight: 400; font-size: 14px; line-height: 19px; color: #707070;">
                Displaying 1 - 30 of 2,766 reviews
            </div>
            <% if (reviews && reviews.length > 0) { %>
                <% reviews.forEach(review => { %>
                    <div class="row mt-3">
                <div class="col-2">
                    <img src="https://images.gr-assets.com/users/1714842419p6/154684875.jpg" style="border-radius: 50%; width: 60%; object-fit: contain;" >
                        <div style="font-family: Georgia, serif; font-weight: 600; font-size: 14px; line-height: 20px; color: #1e1915;"><%= review.user.fullName %></div>
                        <div class="" style="font-family: Arial, sans-serif; font-weight: 400; font-size: 14px; line-height: 19px; color: #707070;">
                            2,544 reviews
                        </div>
                </div>
                  
                <div class="col-10">
                    <div class="d-flex justify-content-between">
                        <div class="ms-auto">
                            <%= review.formattedDate %>
                        </div>
                    </div>
                    <div class="review-container">
                        <div class="mt-2 review-content-short" style="font-family: Arial, sans-serif; font-weight: 400; font-size: 16px; line-height: 23px; color: #1e1915;">
                            <%- review.truncatedContent %>
                            <div class="show-more-button">
                                <a style="font-weight: 600; font-size: 14px; line-height: 20px; color: #1e1915;" class="text-decoration-none show-more-link" data-review-id="<%= review._id %>" href="#">
                                    Show more &#9662;
                                </a>
                            </div>
                        </div>
                        <div class="mt-2 review-content-full" style="display: none;"></div> <!-- Placeholder for full review content -->
                    </div>
                    
                    <div class="review-container" data-review-id="<%= review._id %>">
                        <div class="mt-2" style="font-family: Arial, sans-serif; font-weight: 400; font-size: 14px; line-height: 19px; color: #707070;">
                            <span class="like-count"><%= review.likes.length %></span> likes <span class="comment-count"><%= review.commentCount %></span> comments
                        </div>
                        <div class="mt-2" style="font-family: Arial, sans-serif; font-weight: 600; font-size: 14px; line-height: 20px; color: #1e1915;">
                            <button style="color: <%= review.likedByUser ? '#377458' : '#1e1915' %>; font-family: Arial, sans-serif; font-weight: 600; font-size: 14px; line-height: 20px; background: none; border: none;" class="text-decoration-none like-link" data-review-id="<%= review._id %>" data-liked="<%= review.likedByUser %>">
                                <i class="bi bi-hand-thumbs-up"></i> Like
                            </button>
                            <a id="comment-link-<%= review._id %>" style="font-family: Arial, sans-serif; font-weight: 600; font-size: 14px; line-height: 20px; color: #1e1915;" href="<%= loggedIn ? '' : '/signup' %>" class="text-decoration-none ms-3">
                                <i class="bi bi-chat"></i> Comment
                            </a>
                            <div class="row">
                                <div class="col-12">
                                    <div class="row">
                                        <% review.comments.forEach(comment => { %>
                                        <div class="col-12 mb-3">
                                            <div class="row">
                                                <div class="col-lg-1 col-md-2 col-1 mt-2">
                                                    <div class="user-image-placeholder"></div>
                                                </div>
                                                <div class="col-lg-10 col-md-10 mt-2">
                                                    <div class="d-flex justify-content-between">
                                                        <div class="d-flex">
                                                            <div><%= comment.user.fullName %></div>
                                                            <div class="ms-2"><%= comment.formattedDate %></div>
                                                        </div>
                                                        <div>
                                                            <i class="bi bi-three-dots fs-5"></i>
                                                        </div>
                                                    </div>
                                                    <div><%= comment.content %></div>
                                                </div>
                                            </div>
                                        </div>
                                        <% }) %>
                                    </div>
                                </div>
                            </div>
                            <div id="comment-box-<%= review._id %>" class="comment-box mt-2 d-flex flex-column" style="display: none !important">
                                <div class="comment-input-container">
                                    <div class="user-image-placeholder"></div> <!-- User image placeholder -->
                                    <textarea id="comment-input-<%= review._id %>" class="form-control comment-input" rows="2" placeholder="Add a comment" style="border-color: #707070;"></textarea>
                                </div>
                                <button style="background-color: #1e1915; color: #ffffff; border-radius: 30%;" id="comment-submit-<%= review._id %>" class="btn mt-1 comment-submit ms-auto" data-review-id="<%= review._id %>">Post</button>
                            </div>
                        </div>
                    </div>
                    
                <hr>
                </div>
                <% }) %>
            <% } %>
                <div class="d-flex justify-content-between align-items-center">
                    <!-- Horizontal line to the left -->
                    <hr class="flex-grow-1 mr-3" style="border-top: 2px solid #767676;">
                    <div style="font-family: Arial, sans-serif; font-weight: 600; font-size: 14px; line-height: 20px; color: #1e1915;">More Reviews and ratings ></div>
                    <!-- Horizontal line to the right -->
                    <hr class="flex-grow-1 ml-3" style="border-top: 2px solid #767676;">
                </div>
            </div>
        </div>

        <div class="col-md-2 d-flex ">
            <div class="ms-auto">
                <i class="bi bi-share fs-2"></i>
            </div>
            
        </div>
    </div>
</div>
<div id="loggedInStatus" data-logged-in="<%= loggedIn %>"></div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var showMoreReviewLinks = document.querySelectorAll(".show-more-link");

        showMoreReviewLinks.forEach(function(link) {
            link.addEventListener("click", function(event) {
                event.preventDefault();
                var reviewId = this.getAttribute("data-review-id");
                var reviewContentShort = this.closest('.review-container').querySelector('.review-content-short');
                var reviewContentFull = this.closest('.review-container').querySelector('.review-content-full');

                console.log('Review ID:', reviewId); // Log the review ID
                console.log('Short review content element:', reviewContentShort); // Log the short review content element
                console.log('Full review content element:', reviewContentFull); // Log the full review content element

                fetch(`/book/<%= book._id %>/review/${reviewId}`) // Update the URL to include the book ID
                    .then(response => response.json())
                    .then(data => {
                        console.log('Response from server:', data); // Log the response from the server

                        // Replace the short review content with the full review content
                        reviewContentShort.style.display = 'none';
                        reviewContentFull.innerHTML = data.content;
                        reviewContentFull.style.display = 'block';
                    })
                    .catch(error => console.error('Error fetching review:', error));
            });
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        console.log("Script loaded and DOM content is ready.");
    
        var likeLinks = document.querySelectorAll(".review-container .like-link");
        console.log("Like links found:", likeLinks);
    
        likeLinks.forEach(function(link) {
            link.addEventListener("click", function(event) {
                event.preventDefault();
                console.log("Like link clicked:", this);
    
                var loggedInStatus = document.getElementById('loggedInStatus').getAttribute('data-logged-in');
                var loggedIn = loggedInStatus === 'true';
    
                if (!loggedIn) {
                    console.log("User not logged in, redirecting to signup.");
                    window.location.href = '/signup';
                    return;
                }
    
                var reviewId = this.getAttribute("data-review-id");
                var liked = this.getAttribute("data-liked") === 'true';
                console.log("Review ID:", reviewId, "Already liked:", liked);
    
                var reviewContainer = this.closest('.review-container');
                var likeCountElement = reviewContainer.querySelector('.like-count');
    
                fetch(`/book/<%= book._id %>/review/${reviewId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Like response data:", data);
                    likeCountElement.textContent = data.likes;
    
                    // Toggle the liked status
                    this.setAttribute("data-liked", !liked);
                    this.style.color = !liked ? '#377458' : '#1e1915';
                })
                .catch(error => {
                    console.error('Error liking review:', error);
                });
            });
        });
    });
</script>
    
<script>
    document.addEventListener("DOMContentLoaded", function() {
var commentLinks = document.querySelectorAll('[id^="comment-link-"]');
commentLinks.forEach(function(commentLink) {
    commentLink.addEventListener("click", function(event) {
        event.preventDefault();
        var reviewId = this.getAttribute('id').split('-')[2];
        var commentBox = document.getElementById('comment-box-' + reviewId);
        var commentInput = document.getElementById('comment-input-' + reviewId);
        var postButton = document.getElementById('comment-submit-' + reviewId);
        commentBox.style.display = 'block';
        commentLink.style.display = 'none'; // Hide the comment link
        commentInput.focus(); // Focus on the comment input
        commentBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); // Scroll to the comment box

        // Show post button when user starts typing
        commentInput.addEventListener("input", function() {
                if (commentInput.value.trim() !== '') {
                    postButton.style.display = 'block';
                } else {
                    postButton.style.display = 'none';
                }
            });
    });
    
});
});

</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM fully loaded and parsed');

        document.querySelectorAll('.comment-submit').forEach(button => {
            console.log('Setting up event listener for comment submit button:', button);

            button.addEventListener('click', async (event) => {
                const reviewId = event.target.dataset.reviewId;
                console.log('Review ID:', reviewId);

                const contentElement = document.getElementById(`comment-input-${reviewId}`);
                console.log('Content element:', contentElement);

                if (!contentElement) {
                    console.error(`No comment input found for reviewId: ${reviewId}`);
                    return;
                }

                let content = contentElement.value;
                console.log('Raw content:', content);

                if (typeof content !== 'string') {
                    console.error('Content is not a string:', content);
                    return;
                }

                content = content.trim();
                console.log('Trimmed content:', content);

                if (!content) {
                    console.warn('Comment content is empty, ignoring submission.');
                    return; // Ignore empty comments
                }

                try {
                    console.log('Sending fetch request to submit comment with content:', content);

                    const response = await fetch(`/book/${reviewId}/comment`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content })
                    });

                    console.log('Fetch response received');

                    const data = await response.json();
                    console.log('Response data:', data);

                    if (data.success) {
                        console.log('Comment submission successful, updating UI...');

                        const commentHtml = `
                            <div class="col-12 mb-3">
                                <div class="row">
                                    <div class="col-lg-1 col-md-2 col-1 mt-2">
                                        <div class="user-image-placeholder"></div>
                                    </div>
                                    <div class="col-lg-10 col-md-10 mt-2">
                                        <div class="d-flex justify-content-between">
                                            <div class="d-flex">
                                                <div>${data.comment.userFullName}</div>
                                                <div class="ms-2">${data.comment.formattedDate}</div>
                                            </div>
                                            <div>
                                                <i class="bi bi-three-dots fs-5"></i>
                                            </div>
                                        </div>
                                        <div style="color:red">${data.comment.content}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.getElementById(`comment-box-${reviewId}`).insertAdjacentHTML('afterbegin', commentHtml);
                        contentElement.value = ''; // Clear input

                        // Update comment count
                        const commentCountElement = document.querySelector(`[data-review-id="${reviewId}"] .comment-count`);
                        commentCountElement.textContent = parseInt(commentCountElement.textContent) + 1;

                        document.getElementById(`comment-box-${reviewId}`).style.display = 'block'; // Show comments section
                    } else {
                        console.error('Error from server:', data.error);
                    }
                } catch (error) {
                    console.error('Error submitting comment:', error);
                }
            });
        });
    });
</script>
 